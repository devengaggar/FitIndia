<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FitIndia.pro â€” WHR (Waistâ€“Hip Ratio) & 30-Day Plan</title>
<meta name="theme-color" content="#06038d">
<style>
  :root{
    --white:#ffffff;
    --ink:#0f172a;
    --muted:#475569;
    --line:#e5e7eb;
    --blue:#6991ff;           /* unified (only once) */
    --green:#10b981;
    --orange:#f97316;
    --yellow:#fde047;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#fff;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  img{max-width:100%;height:auto;display:block}
  .wrap{max-width:1140px;margin:0 auto;padding:0 20px}

  /* NAV (fixed 60px, brand rules per spec) */
  .nav{
    position:sticky; top:0; background:#fff; border-bottom:1px solid var(--line);
    z-index:90; height:60px;
  }
  .nav-inner{
    height:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand-logo{
    position:relative; height:100%; width:15%; display:block; min-width:120px;
  }
  .brand-logo img{
    position:absolute; left:0; right:0; top:50%;
    transform:translateY(-50%);
    height:60px; width:auto; margin:0 auto; /* fills bar, no overflow */
  }

  .tabs{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .tabs a, .dropbtn{
    padding:8px 10px; border-radius:10px; color:var(--muted); font-weight:700; line-height:1; outline:none;
  }
  .tabs a:hover, .dropbtn:hover{background:#f8fafc;color:#0b1324}
  .tabs a:focus-visible, .dropbtn:focus-visible{outline:2px solid #93c5fd; outline-offset:2px}
  .tabs a.active{background:#eef2ff;color:#0b1324}

  .cta{display:flex;gap:10px;align-items:center}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;cursor:pointer}
  .btn.primary{
    /* fixed: valid gradient with two stops */
    background:linear-gradient(90deg,var(--ink));
    color:#fff;border:0;
  }
  .btn:focus-visible{outline:2px solid #93c5fd; outline-offset:2px}

  /* Dropdown */
  .dropdown{position:relative;display:inline-block}
  .dropbtn{display:inline-block;padding:8px 10px;border-radius:10px;color:var(--muted);font-weight:700}
  .dropbtn:hover{background:#f8fafc;color:#0b1324}
  .dropdown-content{display:none;position:absolute;top:100%;left:0;background:#fff;min-width:160px;box-shadow:0 4px 8px rgba(0,0,0,.08);border:1px solid var(--line);border-radius:8px;z-index:999}
  .dropdown-content a{display:block;padding:10px 12px;color:var(--muted);font-weight:600;border-radius:6px}
  .dropdown-content a:hover{background:#f8fafc;color:#0b1324}
  .dropdown.open .dropdown-content{display:block}

  /* Hamburger */
  .hamburger{display:inline-flex;gap:6px;flex-direction:column;padding:10px;border:0;background:transparent}
  .hamburger span{width:24px;height:2px;background:#0f172a;border-radius:2px}

  /* Mobile menu */
  .mobile-menu{position:fixed;inset:60px 0 auto 0;background:#fff;border-bottom:1px solid var(--line);display:none;padding:12px 16px}
  .mobile-menu a{display:block;padding:12px 8px;border-radius:8px}
  .mobile-menu .dropdown{display:block}
  .mobile-menu.show{display:block}

  @media(min-width:900px){
    .hamburger{display:none}
    .tabs{display:flex}
    .mobile-menu{display:none!important}
  }
  /* HERO */
  .hero{background:linear-gradient(180deg,#fff,var(--blue) 100%)}
  .hero-grid{
    display:grid; grid-template-columns:1.2fr .8fr; gap:24px; min-height:240px; padding:28px 0 32px;
  }
  @media(max-width:900px){
    .hero-grid{grid-template-columns:1fr; gap:16px; padding:20px 0 24px}
  }

  h1{font-size:clamp(1.7rem,3.6vw,2.6rem);margin:0 0 10px}
  h2.section-title{font-size:clamp(1.2rem,2.3vw,1.7rem);margin:0 0 12px;display:flex;align-items:center;gap:10px}
  .sub{color:#0b1324b0}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--yellow);box-shadow:0 0 0 6px rgba(253,224,71,.35)}

  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}

  /* SECTIONS */
  section{padding:28px 0;border-bottom:1px solid var(--line)}

  .muted{color:var(--muted)}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media(max-width:900px){.grid3{grid-template-columns:1fr}}

  .card img{width:100%;height:160px;object-fit:cover;border-radius:12px;margin-bottom:10px;background:#f1f5f9}

  /* FORM / OUTPUT */
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line)}
  input:focus-visible, select:focus-visible, textarea:focus-visible{outline:2px solid #93c5fd; outline-offset:2px}

  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-weight:700;color:var(--muted)}
  .pill.ok{background:#dcfce7;border-color:#bbf7d0}
  .pill.warn{background:#fff6b0;border:1px dashed #eab308;color:#3f2d00}
  .pill.risk{background:#fee2e2;border-color:#fecaca}

  details summary{cursor:pointer;font-weight:800}
  details > summary:focus-visible{outline:2px solid #93c5fd; outline-offset:4px}

  /* FOOTER */
  footer{background:#0b1324;color:#dbeafe}
  .foot{display:grid;grid-template-columns:2fr 1fr 1fr;gap:20px;padding:28px 0}
  @media(max-width:900px){.foot{grid-template-columns:1fr}}
  .social{display:flex;gap:12px;flex-wrap:wrap}
  .social a{display:inline-flex;align-items:center;gap:6px;background:#0a1228;border:1px solid #1e3a8a;border-radius:999px;padding:6px 10px;color:#c7d2fe}
  .credit{border-top:1px solid #172554;padding:12px 0;color:#9db2d8}

  /* DIALOGS (kept minimal; safe if not present) */
  dialog{border:1px solid var(--line);border-radius:16px;padding:0;max-width:560px;width:92%}
  dialog::backdrop{background:rgba(2,6,23,.35)}
  dialog[open]{display:block;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;box-shadow:0 20px 60px rgba(2,6,23,.25)}
  .dlg-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.35);z-index:9998}
  .dlg-hd{padding:16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
  .dlg-bd{padding:16px}
  .tabbar{display:flex;gap:6px;margin-bottom:10px}
  .tabbar button{flex:1}

  /* Gauge */
  .gauge{width:100%;max-width:420px;margin:10px 0}
  .gauge svg{display:block;width:100%;height:auto}
  .gauge .tick{font:600 10px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif; fill:#475569}
  .gauge .label{font:700 12px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif; fill:#0f172a}
  .gauge .readout{font:800 18px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif; fill:#0f172a}
  .gauge .needle{transition:transform .9s cubic-bezier(.22,1,.36,1); transform-origin:210px 210px}
  .gauge .hub{fill:#0f172a}

  @media (prefers-reduced-motion: reduce){
    .gauge .needle{transition:none}
    html:focus-within{scroll-behavior:auto}
  }
</style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav" aria-label="Primary">
    <div class="wrap nav-inner">
      <a href="index.html" class="brand-logo" aria-label="FitIndia Home">
        <img src="img/Fit-India-Logo.png" alt="FitIndia.pro logo">
      </a>

      <div class="tabs" role="navigation" aria-label="Primary links">
        <a id="homeTop" href="index.html" target="_self">Home</a>
        <a id="servicesTop" href="services.html" target="_self">Services</a>
        <a id="AnnouncementsTop" href="Announcements.html" target="_self">Announcements</a>

        <!-- Tools dropdown -->
        <div class="dropdown" id="toolsMenu">
          <button class="dropbtn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="toolsList">Tools â–¾</button>
          <div class="dropdown-content" id="toolsList" role="menu">
            <a id="navBMI" href="Bmi-cal.html" target="_self" role="menuitem">BMI</a>
            <a id="navWHR" href="WHR.html" target="_self" role="menuitem" class="active">WHR</a>
          </div>
        </div>

        <a id="aboutTop" href="about-us.html" target="_self">About Us</a>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero" id="whr">
    <div class="wrap hero-grid">
      <div>
        <h1>Waistâ€“Hip Ratio (WHR)</h1>
        <p class="muted">Check your WHR, get professional feedback, and receive a personalised 30-day plan with exercise, steps, and weekly meal templates.</p>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Whatâ€™s inside</h3>
        <ul style="margin:0 0 8px 18px;line-height:1.65">
          <li>Personalised 30-day plan (exercise, steps, wellbeing)</li>
          <li>7-day meal templates, repeating weekly</li>
        </ul>
      </div>
    </div>
  </header>

  <!-- WHR CALCULATOR -->
  <section id="calcCard">
    <div class="wrap">
      <div class="card">
        <h2 class="section-title"><span class="dot"></span>WHR Calculator</h2>
        <div class="row">
          <div class="field"><label>Waist (cm)<input id="waist" type="number" min="40" max="200" step="0.1" placeholder="84"></label></div>
          <div class="field"><label>Hip (cm)<input id="hip" type="number" min="50" max="200" step="0.1" placeholder="94"></label></div>
        </div>
        <div class="row">
          <div class="field">
            <label>Sex at birth
              <select id="sex">
                <option value="female">Female</option>
                <option value="male">Male</option>
              </select>
            </label>
          </div>
        </div>

        <div class="cta" style="margin-top:8px;flex-wrap:wrap;align-items:center;gap:10px">
          <button class="btn primary" id="calcWHR">Calculate WHR</button>
          <button class="btn" id="resetWHR" style="display:none">Reset</button>
          <span id="whrVal" class="pill" style="display:none"></span>
        </div>

        <!-- Dial shows only after a successful calculation -->
        <div id="whrDial" class="gauge" aria-live="polite" style="display:none"></div>

        <p id="whrMsg" class="muted" style="margin-top:6px"></p>
        <p id="whrTarget" class="pill" style="display:none;margin-top:8px"></p>
      </div>
    </div>
  </section>

  <!-- PERSONALISE -->
  <section>
    <div class="wrap">
      <div class="card" id="formCard" style="display:none">
        <h2 class="section-title"><span class="dot"></span>Personalise Your Plan</h2>
        <div class="row">
          <div class="field"><label>Name<input id="name" type="text" placeholder="Full name (optional)"></label></div>
          <div class="field"><label>Age (years)<input id="age" type="number" min="12" max="100" placeholder="28"></label></div>
        </div>
        <div class="row">
          <div class="field">
            <label>Diet preference
              <select id="diet">
                <option>Vegetarian</option><option>Vegan</option><option>Eggetarian</option><option>Non-veg</option>
              </select>
            </label>
          </div>
          <div class="field"><label>Dietary restrictions (optional)<input id="restrict" type="text" placeholder="e.g., Jain, no peanuts, low lactose"></label></div>
        </div>
        <div class="cta" style="margin-top:8px">
          <button class="btn primary" id="buildPlan">Generate 30-Day Plan</button>
          <button class="btn" id="reset">Reset</button>
        </div>
      </div>
    </div>
  </section>

  <!-- PLAN OUTPUT -->
  <section id="plan" style="display:none">
    <div class="wrap">
      <div class="card">
        <h2 class="section-title"><span class="dot"></span>Your 30-Day Exercise & Diet Plan</h2>
        <div id="advice" class="pill ok" style="margin-bottom:10px"></div>
        <div id="range" class="pill" style="margin-bottom:10px"></div>

        <h3>Weekly Goals</h3>
        <ul id="weeklyGoals" class="muted" style="line-height:1.6"></ul>

        <h3 style="margin-top:14px">Day-wise Schedule</h3>
        <div id="daywise"></div>

        <h3 style="margin-top:14px">7-Day Meal Template (repeats weekly)</h3>
        <div id="meals"></div>

        <div class="cta" style="margin-top:12px"><button class="btn" id="download">Download Plan (TXT)</button></div>
        <p class="muted" style="margin-top:10px">General wellness guidance; not a substitute for medical advice.</p>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="wrap foot">
      <div><h3 style="margin:0 0 8px">FitIndia.pro</h3><p>Your partner in evidence-based weight care.</p></div>
      <div><h4>Pages</h4>
        <ul style="list-style:none;padding:0;line-height:1.9">
          <li><a href="about-us.html" target="_self">About Us</a></li>
          <li><a href="services.html" target="_self">Services</a></li>
          <li><a href="Announcements.html" target="_self">Announcements</a></li>
        </ul>
      </div>
      <div><h4>Follow us</h4>
        <div class="social">
          <a href="https://instagram.com/fitindia.pro" target="_self">ðŸ“¸ Instagram</a>
          <a href="https://www.linkedin.com/company/fitindia-pro" target="_self">ðŸ’¼ LinkedIn</a>
          <a href="https://facebook.com/fitindia.pro" target="_self">ðŸ“˜ Facebook</a>
          <a href="https://wa.me/0000000000" target="_self">ðŸ’¬ WhatsApp</a>
        </div>
      </div>
    </div>
    <div class="wrap credit">Â© <span id="year"></span> FitIndia.pro â€¢ All rights reserved.</div>
  </footer>

<script>
(() => {
  'use strict';

  /* ===== Helpers ===== */
  const $  = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  function getSession(){ try { return JSON.parse(localStorage.getItem('fitindia_session')||'null')||null; } catch { return null; } }
  function getSessionEmail(){ return getSession()?.email || null; }

  const METRIC_KEY = (email) => `fitindia_metrics_${email}`;
  function loadMetrics(email){ try { return JSON.parse(localStorage.getItem(METRIC_KEY(email))||'{}'); } catch { return {}; } }
  function saveMetrics(email, obj){
    const cur = loadMetrics(email);
    localStorage.setItem(METRIC_KEY(email), JSON.stringify({ ...cur, ...obj }));
  }

  /* ===== Footer year & smooth scroll ===== */
  const yearEl = $('#year'); if (yearEl) yearEl.textContent = new Date().getFullYear();
  $$('.tabs a[href^="#"], footer a[href^="#"]').forEach(a => {
    a.addEventListener('click', (e) => {
      const t = document.querySelector(a.getAttribute('href'));
      if (t){ e.preventDefault(); t.scrollIntoView({behavior:'smooth'}); }
    });
  });

  /* ===== Dropdown: mobile/keyboard toggle ===== */
  const toolsMenu = $('#toolsMenu');
  if (toolsMenu){
    const btn = toolsMenu.querySelector('.dropbtn');
    const list = toolsMenu.querySelector('.dropdown-content');
    const close = () => { toolsMenu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); };
    const open  = () => { toolsMenu.classList.add('open'); btn.setAttribute('aria-expanded','true'); };
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); toolsMenu.classList.contains('open') ? close() : open(); });
    document.addEventListener('click', (e)=>{ if (!toolsMenu.contains(e.target)) close(); });
    btn.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowDown'){ open(); list?.querySelector('a')?.focus(); }
      if (e.key === 'Escape'){ close(); btn.focus(); }
    });
  }

  /* ===== Dialog helpers (safe if dialog not present) ===== */
  const supportsDialog = (typeof HTMLDialogElement !== 'undefined')
    && (typeof document.createElement('dialog').showModal === 'function');

  function openDialog(id){
    const dlg = document.getElementById(id);
    if (!dlg) return;
    if (supportsDialog) {
      try { dlg.showModal(); }
      catch(e){ dlg.removeAttribute('open'); setTimeout(() => dlg.showModal(), 0); }
    } else {
      dlg.setAttribute('open','');
      let bg = document.querySelector(`.dlg-backdrop[data-for="${id}"]`);
      if (!bg) {
        bg = document.createElement('div');
        bg.className = 'dlg-backdrop';
        bg.dataset.for = id;
        document.body.appendChild(bg);
        bg.addEventListener('click', () => closeDialog(dlg));
      }
    }
  }
  function closeDialog(dlg){
    if (!dlg) return;
    if (supportsDialog && typeof dlg.close === 'function') dlg.close();
    else dlg.removeAttribute('open');
    const bg = document.querySelector(`.dlg-backdrop[data-for="${dlg.id}"]`);
    if (bg) bg.remove();
  }
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const d = document.querySelector('dialog[open]');
      if (d) closeDialog(d);
    }
  });

  /* ===== Auth state button (safe if button/dialog absent) ===== */
  let isAuthed = !!getSessionEmail();
  let pendingBuild = false;
  let showLoginFn = null;

  function flipAuthButton(){
    const email = getSessionEmail();
    const authBtn = document.getElementById('openAuth');
    if (!authBtn) return;
    if (email){
      authBtn.textContent = 'Go to Dashboard';
      authBtn.onclick = () => location.assign('Dashboard.html');
    } else {
      authBtn.textContent = 'Login / Sign up';
      authBtn.onclick = () => { if (typeof showLoginFn === 'function') showLoginFn(); openDialog('authDlg'); };
    }
  }
  flipAuthButton();

  (function authUI(){
    const dlg = document.getElementById('authDlg'); if (!dlg) return;

    const authTitle   = document.getElementById('authTitle');
    const tabLogin    = document.getElementById('tabLogin');
    const tabSignup   = document.getElementById('tabSignup');
    const loginPane   = document.getElementById('loginPane');
    const signupPane  = document.getElementById('signupPane');
    const linkToSignup= document.getElementById('linkToSignup');
    const linkToLogin = document.getElementById('linkToLogin');
    const authError   = document.getElementById('authError');
    const loginEmail  = document.getElementById('loginEmail');
    const loginPwd    = document.getElementById('loginPwd');
    const suName      = document.getElementById('suName');
    const suEmail     = document.getElementById('suEmail');
    const suPwd       = document.getElementById('suPwd');
    const suPwd2      = document.getElementById('suPwd2');
    const loginSubmit = document.getElementById('loginSubmit');
    const signupSubmit= document.getElementById('signupSubmit');

    function setError(msg){ if (authError){ authError.textContent = msg; authError.style.display = 'inline-block'; } }
    function clearError(){ if (authError){ authError.style.display='none'; authError.textContent=''; } }

    function showLogin(){
      if (authTitle) authTitle.textContent='Login';
      if (loginPane)  loginPane.style.display='block';
      if (signupPane) signupPane.style.display='none';
      tabLogin?.classList.add('primary'); tabSignup?.classList.remove('primary');
      tabLogin?.setAttribute('aria-selected','true'); tabSignup?.removeAttribute('aria-selected');
      clearError();
    }
    function showSignup(){
      if (authTitle) authTitle.textContent='Sign Up';
      if (loginPane)  loginPane.style.display='none';
      if (signupPane) signupPane.style.display='block';
      tabSignup?.classList.add('primary'); tabLogin?.classList.remove('primary');
      tabSignup?.setAttribute('aria-selected','true'); tabLogin?.removeAttribute('aria-selected');
      clearError();
    }
    showLoginFn = showLogin;

    tabLogin?.addEventListener('click', showLogin);
    tabSignup?.addEventListener('click', showSignup);
    linkToSignup?.addEventListener('click', (e)=>{ e.preventDefault(); showSignup(); });
    linkToLogin ?.addEventListener('click', (e)=>{ e.preventDefault(); showLogin(); });
    dlg.addEventListener('close', showLogin);

    const KEY='fitindia_users';
    const getUsers=()=>{ try { return JSON.parse(localStorage.getItem(KEY))||[]; } catch { return []; } };
    const setUsers=(arr)=>localStorage.setItem(KEY, JSON.stringify(arr));
    const hash=(s)=>btoa(unescape(encodeURIComponent(s))); // demo only
    let lastAuthEmail = null;

    loginSubmit?.addEventListener('click', (e)=>{
      clearError();
      const email=(loginEmail?.value||'').trim().toLowerCase();
      const pwd  =(loginPwd?.value||'');
      if(!email || !pwd){ e.preventDefault(); setError('Please enter email and password.'); return; }
      const u = getUsers().find(x=>x.email===email);
      if(!u || u.hash!==hash(pwd)){ e.preventDefault(); setError('Invalid email or password.'); return; }
      lastAuthEmail = email;
    });

    signupSubmit?.addEventListener('click', (e)=>{
      clearError();
      const name =(suName?.value||'').trim();
      const email=(suEmail?.value||'').trim().toLowerCase();
      const pwd  =(suPwd?.value||'');
      const pwd2 =(suPwd2?.value||'');
      if(!name || !email || !pwd || !pwd2){ e.preventDefault(); setError('Please fill all fields.'); return; }
      if(pwd.length<8){ e.preventDefault(); setError('Password must be at least 8 characters.'); return; }
      if(pwd!==pwd2){ e.preventDefault(); setError('Passwords do not match.'); return; }
      const users = getUsers();
      if(users.some(x=>x.email===email)){ e.preventDefault(); setError('Account already exists. Try logging in.'); return; }
      users.push({email, name, hash:hash(pwd)}); setUsers(users);
      lastAuthEmail = email;
    });

    dlg.addEventListener('close', ()=>{
      if (dlg.returnValue==='ok' && lastAuthEmail){
        localStorage.setItem('fitindia_session', JSON.stringify({ email:lastAuthEmail, ts:Date.now() }));
        isAuthed = true; lastAuthEmail = null; flipAuthButton();
        if (pendingBuild) { pendingBuild=false; buildPlanNow(); }
      } else {
        lastAuthEmail = null;
      }
    });

    flipAuthButton();
  })();

  /* ===== WHR Calculator ===== */
  let lastWHR = null, lastCat = '', riskLabel = '';
  let waistCm = 0, hipCm = 0, sex = 'female';

  const waistEl   = document.getElementById('waist');
  const hipEl     = document.getElementById('hip');
  const sexSel    = document.getElementById('sex');
  const whrVal    = document.getElementById('whrVal');
  const whrMsg    = document.getElementById('whrMsg');
  const whrTarget = document.getElementById('whrTarget');

  document.getElementById('calcWHR')?.addEventListener('click', () => {
    waistCm = parseFloat(waistEl?.value||''); hipCm = parseFloat(hipEl?.value||''); sex = sexSel?.value || 'female';
    if (!isFinite(waistCm) || !isFinite(hipCm) || waistCm<=0 || hipCm<=0){
      if (whrVal)    whrVal.style.display='none';
      if (whrMsg)    whrMsg.textContent='Please enter valid waist and hip values.';
      if (whrTarget) whrTarget.style.display='none';
      const fc = document.getElementById('formCard'); if (fc) fc.style.display='none';
      const pl = document.getElementById('plan');     if (pl) pl.style.display='none';
      lastWHR=null; lastCat=''; riskLabel=''; return;
    }

    const r = waistCm / hipCm; lastWHR = r;
    const rv = (Math.round(r * 100) / 100).toFixed(2);

    // Indian cut-offs
    let cls='ok';
    if (sex==='female'){
      if (r < 0.80){ lastCat='Standard Range'; cls='ok';  riskLabel='Low';      if (whrMsg) whrMsg.textContent='Keep up balanced meals and regular activity.'; }
      else if (r < 0.85){ lastCat='Increased Risk'; cls='warn'; riskLabel='Moderate'; if (whrMsg) whrMsg.textContent='Central adiposity rising â€” prioritise fibre, portions, daily walks, and strength.'; }
      else { lastCat='High Risk'; cls='risk'; riskLabel='High'; if (whrMsg) whrMsg.textContent='High central adiposity â€” gradual plan with clinician oversight recommended.'; }
    } else {
      if (r < 0.90){ lastCat='Standard Range'; cls='ok';  riskLabel='Low';      if (whrMsg) whrMsg.textContent='Keep up balanced meals and regular activity.'; }
      else if (r < 1.00){ lastCat='Increased Risk'; cls='warn'; riskLabel='Moderate'; if (whrMsg) whrMsg.textContent='Central adiposity rising â€” prioritise fibre, portions, daily walks, and strength.'; }
      else { lastCat='High Risk'; cls='risk'; riskLabel='High'; if (whrMsg) whrMsg.textContent='High central adiposity â€” gradual plan with clinician oversight recommended.'; }
    }

    if (whrVal){
      whrVal.textContent = `WHR: ${rv} â€” ${lastCat}`;
      whrVal.className = 'pill ' + cls;
      whrVal.style.display = 'inline-block';
    }

    const target = (sex==='female') ? 'â‰¤ 0.85' : 'â‰¤ 1.00';
    if (whrTarget){
      whrTarget.textContent = `Suggested target WHR ${target} (${sex}). Re-check monthly.`;
      whrTarget.style.display = 'inline-block';
    }

    const email = getSessionEmail();
    if (email){
      saveMetrics(email, {
        whr: { value: Number(rv), waist_cm: Number(waistCm), hip_cm: Number(hipCm), risk: riskLabel, ts: Date.now() }
      });
    }

    const fc = document.getElementById('formCard');
    if (fc){ fc.style.display='block'; fc.scrollIntoView({behavior:'smooth'}); }
  });

  // Reset (form section)
  document.getElementById('reset')?.addEventListener('click', () => {
    ['waist','hip','name','age','restrict'].forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
    const dietSel = document.getElementById('diet'); if (dietSel) dietSel.selectedIndex = 0;
    if (whrVal)    whrVal.style.display='none';
    if (whrTarget) whrTarget.style.display='none';
    if (whrMsg)    whrMsg.textContent='';
    const fc = document.getElementById('formCard'); if (fc) fc.style.display='none';
    const pl = document.getElementById('plan');     if (pl) pl.style.display='none';
    lastWHR=null; lastCat=''; riskLabel='';
    window.scrollTo({top:0,behavior:'smooth'});
  });

  // Build button -> login gate if needed
  document.getElementById('buildPlan')?.addEventListener('click', () => {
    if (!lastWHR){ alert('Please calculate your WHR first.'); return; }
    if (!isAuthed){
      pendingBuild = true;
      if (typeof showLoginFn === 'function') showLoginFn();
      openDialog('authDlg');
      return;
    }
    buildPlanNow();
  });

  /* ===== Plan builder ===== */
  function buildPlanNow(){
    const name = (document.getElementById('name')?.value||'').trim();
    const age  = parseInt(document.getElementById('age')?.value||'',10);
    const diet = document.getElementById('diet')?.value || 'Vegetarian';
    const restr= (document.getElementById('restrict')?.value||'').trim();
    const dietLine = `Diet: ${diet}${restr ? ` â€¢ Avoid: ${restr}` : ''}`;

    const high = (sex==='female' ? lastWHR>=0.85 : lastWHR>=1.00);
    const increased = (!high) && (sex==='female' ? lastWHR>=0.80 : lastWHR>=0.90);
    const healthy = !high && !increased;

    let color='ok', headline='';
    if (healthy){ color='ok';   headline='Standard Range â€” maintain and refine.'; }
    else if (increased){ color='warn'; headline='Increased Risk â€” focus on waist reduction safely.'; }
    else { color='risk'; headline='High Risk â€” gradual plan with clinician oversight advised.'; }

    const advice = document.getElementById('advice');
    const range  = document.getElementById('range');
    if (advice){ advice.textContent = `${name?name+', ':''}Your category: ${lastCat}. ${headline}`; advice.className = `pill ${color}`; }
    if (range){ range.textContent = `Target WHR ${(sex==='female')?'â‰¤ 0.85':'â‰¤ 1.00'} â€¢ Re-measure monthly`; }

    // Weekly goals
    const stepsBase = high ? 8000 : (increased ? 9000 : 8000);
    const strengthDays = high ? 2 : 3;
    const proteinTip = (diet==='Vegan' || diet==='Vegetarian')
      ? 'Dal/beans, tofu/paneer*, curd/soy-curd; aim 0.8â€“1.2 g/kg protein (*paneer if dairy ok).'
      : 'Lean protein: eggs, chicken/fish, dal/beans, curd; aim 0.8â€“1.2 g/kg protein.';
    const weekly = [
      `Week 1: Plate method (Â½ veg, Â¼ protein, Â¼ carbs); ${stepsBase.toLocaleString()} steps/day; â‰¥2 L water.`,
      `Week 2: ${strengthDays}Ã— strength (20â€“30 min); ${proteinTip}`,
      `Week 3: Cut added sugars/UPFs; 10â€“15 min post-meal walks.`,
      `Week 4: Review progress; adjust portions; plan next month.`
    ];
    const weeklyUL = document.getElementById('weeklyGoals');
    if (weeklyUL) weeklyUL.innerHTML = weekly.map(g=>`<li>${g}</li>`).join('');

    // Day-wise plan
    const setHigh = [
      {ex:'Low-impact cardio 25â€“35 min', steps:`${stepsBase}`, mental:'5-min breathing + gratitude'},
      {ex:'Strength (full body 20â€“25 min)', steps:`${stepsBase-1500}`, mental:'2Ã—3-min stretch breaks'},
      {ex:'Intervals 1.5 min brisk / 2 min easy Ã—6', steps:`${stepsBase+500}`, mental:'10-min mindfulness'},
      {ex:'Yoga/mobility 20â€“25 min', steps:`${stepsBase-1000}`, mental:'Positive social'},
      {ex:'Strength (lower body 20â€“25 min)', steps:`${stepsBase-1200}`, mental:'Sleep wind-down'},
      {ex:'Long walk 40â€“50 min', steps:`${stepsBase+800}`, mental:'After-dinner walk'},
      {ex:'Active recovery 20â€“30 min', steps:`${stepsBase-2000}`, mental:'Stretch + journaling'}
    ];
    const setInc = [
      {ex:'Brisk walk 30â€“40 min', steps:`${stepsBase}`, mental:'5-min breathing + gratitude'},
      {ex:'Strength (full body 20â€“30 min)', steps:`${stepsBase-1500}`, mental:'2Ã—3-min stretch breaks'},
      {ex:'Intervals 2 min brisk / 2 min easy Ã—6', steps:`${stepsBase+500}`, mental:'10-min mindfulness'},
      {ex:'Yoga/mobility 25 min', steps:`${stepsBase-1000}`, mental:'Positive social'},
      {ex:'Strength (lower body 25 min)', steps:`${stepsBase-1200}`, mental:'Sleep wind-down'},
      {ex:'Long walk 45â€“60 min', steps:`${stepsBase+1000}`, mental:'After-dinner walk'},
      {ex:'Active recovery 20â€“30 min', steps:`${stepsBase-2000}`, mental:'Stretch + journal'}
    ];
    const setOk = [
      {ex:'Brisk walk 30â€“40 min', steps:`${stepsBase}`, mental:'5-min breathing + gratitude'},
      {ex:'Strength (full body 20â€“30 min)', steps:`${stepsBase-1000}`, mental:'2Ã—3-min stretch breaks'},
      {ex:'Intervals 2 min brisk / 2 min easy Ã—6', steps:`${stepsBase+300}`, mental:'10-min mindfulness'},
      {ex:'Yoga/mobility 25 min', steps:`${stepsBase-800}`, mental:'Positive social'},
      {ex:'Strength (lower body 25 min)', steps:`${stepsBase-1000}`, mental:'Sleep wind-down'},
      {ex:'Long walk 45â€“60 min', steps:`${stepsBase+700}`, mental:'After-dinner walk'},
      {ex:'Active recovery 20â€“30 min', steps:`${stepsBase-1800}`, mental:'Stretch + journal'}
    ];
    const set = (high ? setHigh : (increased ? setInc : setOk));

    const days = [];
    for (let d=1; d<=30; d++){ const a=set[(d-1)%7]; days.push({day:d, ...a}); }

    const daywise = document.getElementById('daywise');
    if (daywise){
      daywise.innerHTML='';
      for (let w=0; w<4; w++){
        const start=w*7, end=Math.min(start+7,30);
        const det=document.createElement('details'); det.open=(w===0);
        const sum=document.createElement('summary'); sum.textContent=`Week ${w+1} â€” ${dietLine}`; det.appendChild(sum);
        const ul=document.createElement('ul'); ul.style.lineHeight='1.6';
        for (let i=start; i<end; i++){
          const d=days[i]; const li=document.createElement('li');
          li.textContent = `Day ${d.day}: Exercise â€” ${d.ex}; Steps â€” ${Number(d.steps).toLocaleString()}; Mental â€” ${d.mental}.`;
          ul.appendChild(li);
        }
        det.appendChild(ul); daywise.appendChild(det);
      }
    }

    // Meals (7-day template Ã—4)
    const veg = (diet==='Vegan' || diet==='Vegetarian' || diet==='Eggetarian'), eggsOK=(diet==='Eggetarian');
    const mealsWeek = [
      {b: veg ? "Poha + veggies + curd/soy-curd" : "Masala omelette + 1â€“2 rotis",
       l: veg ? "Dal + brown rice + salad"      : "Grilled chicken + salad + roti",
       d: veg ? "Paneer/tofu bhurji + roti + sabzi" : "Fish curry + brown rice + sabzi"},
      {b: veg ? "Upma + peanuts"                 : "Egg bhurji + toast",
       l: veg ? "Rajma + rice + salad"           : "Chicken tikka + roti + salad",
       d: veg ? "Veg khichdi + curd/soy-curd"    : "Mutton stew (lean) + roti + salad"},
      {b: veg ? "Oats + nuts + fruit"            : (eggsOK ? "Egg oats + fruit" : "Oats + nuts + fruit"),
       l: veg ? "Chole + roti + salad"           : "Fish tikka + roti + salad",
       d: veg ? "Dosa + sambar + podi"           : "Chicken curry + rice + salad"},
      {b: veg ? "Moong chilla + chutney"         : (eggsOK ? "Moong chilla + eggs" : "Moong chilla + chutney"),
       l: veg ? "Curd rice + salad"              : "Keema (lean) + roti + salad",
       d: veg ? "Tofu/paneer stir-fry + millet"  : "Grilled fish + millet + veggies"},
      {b: veg ? "Idli + sambar"                  : (eggsOK ? "Idli + sambar + eggs" : "Idli + sambar"),
       l: veg ? "Veg pulao + raita"              : "Chicken pulao + raita",
       d: veg ? "Palak paneer/tofu + roti"       : "Egg curry + roti + salad"},
      {b: veg ? "Dalia + nuts + fruit"           : (eggsOK ? "Dalia + eggs + fruit" : "Dalia + nuts + fruit"),
       l: veg ? "Mixed dal + roti + sabzi"       : "Fish curry + roti + salad",
       d: veg ? "Veg biryani (brown rice) + raita" : "Chicken biryani (controlled portion) + raita"},
      {b: veg ? "Besan chilla + curd/soy-curd"   : (eggsOK ? "Besan chilla + eggs" : "Besan chilla + curd"),
       l: veg ? "Sambar + rice + salad"          : "Chicken stew + rice + salad",
       d: veg ? "Paneer/tofu tikka + salad + roti" : "Tandoori chicken + salad + roti"}
    ];
    const mealsDiv = document.getElementById('meals');
    if (mealsDiv){
      mealsDiv.innerHTML='';
      for (let w=0; w<4; w++){
        const det=document.createElement('details'); det.open=(w===0);
        const sum=document.createElement('summary'); sum.textContent=`Meals â€” Week ${w+1}`; det.appendChild(sum);
        const ul=document.createElement('ul'); ul.style.lineHeight='1.7';
        for (let i=0;i<7;i++){
          const d=mealsWeek[i];
          const li=document.createElement('li');
          li.innerHTML = `<strong>Day ${i+1}</strong>: <span class="muted">Breakfast:</span> ${d.b}; <span class="muted">Lunch:</span> ${d.l}; <span class="muted">Dinner:</span> ${d.d}.`;
          ul.appendChild(li);
        }
        det.appendChild(ul); mealsDiv.appendChild(det);
      }
    }

    // Show plan
    const plan = document.getElementById('plan');
    if (plan){ plan.style.display='block'; plan.scrollIntoView({behavior:'smooth', block:'start'}); }

    // Download (TXT)
    const dl = document.getElementById('download');
    if (dl){
      dl.onclick = () => {
        const weeksOut = Array.from(document.getElementById('weeklyGoals')?.children||[]).map(li=>'- '+li.textContent).join('\n');
        const dayOut   = Array.from(document.getElementById('daywise')?.querySelectorAll('li')||[]).map(li=>'- '+li.textContent).join('\n');
        const mealOut  = Array.from(document.getElementById('meals')?.querySelectorAll('details')||[]).map((det,i)=>{
          const lines = Array.from(det.querySelectorAll('li')).map(li=>'  - '+li.textContent).join('\n');
          return `Week ${i+1} Meals:\n${lines}`;
        }).join('\n\n');
        const txt = `FitIndia.pro â€” WHR 30-Day Plan
Name: ${name||'-'} â€¢ Age: ${isFinite(age)?age:'-'}
Waist: ${isFinite(waistCm)?waistCm+' cm':'-'} â€¢ Hip: ${isFinite(hipCm)?hipCm+' cm':'-'}
Sex: ${sex} â€¢ Category: ${lastCat} â€¢ WHR: ${(Math.round(lastWHR*100)/100).toFixed(2)}
${document.getElementById('range')?.textContent||''}

${document.getElementById('advice')?.textContent||''}

Weekly Goals:
${weeksOut}

Day-wise Schedule:
${dayOut}

${mealOut}
`;
        const blob = new Blob([txt], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='fitindia-whr-30-day-plan.txt'; a.click();
        URL.revokeObjectURL(url);
      };
    }
  }

  /* ===== Gauge (single build) ===== */
  const calcBtn  = document.getElementById('calcWHR');
  const resetBtn = document.getElementById('resetWHR');
  const dialWrap = document.getElementById('whrDial');
  if (calcBtn && resetBtn && dialWrap){
    let setWHR = null;
    (function buildGauge(){
      const MIN = 0.60, MAX = 1.20;
      const SEGMENTS = [
        { from: 0.60, to: 0.80, color:'#22c55e', label:'Std'  },
        { from: 0.80, to: 0.90, color:'#f59e0b', label:'Inc'  },
        { from: 0.90, to: 1.20, color:'#ef4444', label:'High' }
      ];

      const W=420, H=260, CX=210, CY=210, R=170;
      const NS='http://www.w3.org/2000/svg';
      const svg=document.createElementNS(NS,'svg');
      svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
      dialWrap.appendChild(svg);

      const toXY=(deg, r=R)=>{ const rad=(deg-90)*Math.PI/180; return [CX+r*Math.cos(rad), CY+r*Math.sin(rad)]; };
      const arc=(a1,a2,r=R)=>{ const [sx,sy]=toXY(a1,r), [ex,ey]=toXY(a2,r); const big=a2-a1>180?1:0; return `M ${sx} ${sy} A ${r} ${r} 0 ${big} 1 ${ex} ${ey}`; };
      const angle=(v)=>{ const c=Math.max(MIN,Math.min(MAX,v)); const t=(c-MIN)/(MAX-MIN); return -90 + t*180; };

      // Bands
      SEGMENTS.forEach(s=>{
        const p=document.createElementNS(NS,'path');
        p.setAttribute('d', arc(angle(s.from), angle(Math.min(s.to,MAX)), R));
        p.setAttribute('fill','none'); p.setAttribute('stroke',s.color);
        p.setAttribute('stroke-width','18'); p.setAttribute('stroke-linecap','round');
        svg.appendChild(p);
      });

      // Track
      const track=document.createElementNS(NS,'path');
      track.setAttribute('d', arc(-90,90,R+14));
      track.setAttribute('fill','none'); track.setAttribute('stroke','#e5e7eb'); track.setAttribute('stroke-width','2');
      svg.appendChild(track);

      // Ticks (every 0.1)
      for (let v=MIN; v<=MAX+1e-9; v=+(v+0.1).toFixed(2)) {
        const a=angle(v);
        const [x1,y1]=toXY(a,R-6), [x2,y2]=toXY(a,R+8);
        const tick=document.createElementNS(NS,'line');
        tick.setAttribute('x1',x1); tick.setAttribute('y1',y1);
        tick.setAttribute('x2',x2); tick.setAttribute('y2',y2);
        tick.setAttribute('stroke','#94a3b8'); tick.setAttribute('stroke-width','2');
        svg.appendChild(tick);

        const [tx,ty]=toXY(a,R+26);
        const txt=document.createElementNS(NS,'text');
        txt.setAttribute('x',tx); txt.setAttribute('y',ty);
        txt.setAttribute('text-anchor','middle'); txt.setAttribute('dominant-baseline','middle');
        txt.setAttribute('class','tick'); txt.textContent=v.toFixed(1);
        svg.appendChild(txt);
      }

      // Labels
      SEGMENTS.forEach(s=>{
        const mid=(s.from+Math.min(s.to,MAX))/2, a=angle(mid);
        const [lx,ly]=toXY(a,R-36);
        const t=document.createElementNS(NS,'text');
        t.setAttribute('x',lx); t.setAttribute('y',ly);
        t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle');
        t.setAttribute('class','label'); t.setAttribute('fill','#334155'); t.textContent=s.label;
        svg.appendChild(t);
      });

      // Needle
      const needle=document.createElementNS(NS,'g'); needle.setAttribute('class','needle');
      const shaft=document.createElementNS(NS,'path'); shaft.setAttribute('d',`M ${CX} ${CY} L ${CX} ${CY-R+24}`);
      shaft.setAttribute('stroke','#0f172a'); shaft.setAttribute('stroke-width','4'); shaft.setAttribute('stroke-linecap','round');
      needle.appendChild(shaft);
      const hub=document.createElementNS(NS,'circle'); hub.setAttribute('cx',CX); hub.setAttribute('cy',CY); hub.setAttribute('r',7); hub.setAttribute('class','hub');
      needle.appendChild(hub);
      svg.appendChild(needle);

      // Readout
      const read=document.createElementNS(NS,'text');
      read.setAttribute('x',CX); read.setAttribute('y',CY-24);
      read.setAttribute('text-anchor','middle'); read.setAttribute('class','readout');
      read.textContent='WHR â€”'; svg.appendChild(read);

      // Updater with a small overshoot
      setWHR = function(val){
        const clamped=Math.max(0.60,Math.min(1.20,val));
        const tgt=angle(clamped);
        const cur=parseFloat((needle._angle ?? -90));
        const over = tgt + Math.sign(tgt-cur)*6;

        needle.style.transitionDuration='450ms';
        needle.style.transform=`rotate(${over}deg)`; needle._angle = over;
        setTimeout(()=>{
          needle.style.transitionDuration='600ms';
          needle.style.transform=`rotate(${tgt}deg)`; needle._angle = tgt;
        },460);

        read.textContent=`WHR ${clamped.toFixed(2)}`;
        dialWrap.setAttribute('aria-label',`WHR ${clamped.toFixed(2)} on dial from ${MIN} to ${MAX}`);
      };

      needle.style.transform='rotate(-90deg)';
    })();

    // Wire calc/reset to dial visibility
    calcBtn.addEventListener('click', () => {
      const waist = parseFloat(document.getElementById('waist')?.value || '');
      const hip   = parseFloat(document.getElementById('hip')?.value   || '');
      if (!isFinite(waist) || !isFinite(hip) || waist<=0 || hip<=0) {
        dialWrap.style.display='none';
        resetBtn.style.display='none';
        return;
      }
      const ratio = waist / hip;
      if (dialWrap.style.display!=='block') dialWrap.style.display='block';
      resetBtn.style.display='inline-block';
      if (typeof setWHR === 'function') setWHR(ratio);
    });

    resetBtn.addEventListener('click', () => {
      ['waist','hip'].forEach(id => { const el=document.getElementById(id); if (el) el.value=''; });
      const whrVal    = document.getElementById('whrVal');
      const whrMsg    = document.getElementById('whrMsg');
      const whrTarget = document.getElementById('whrTarget');
      if (whrVal)    whrVal.style.display='none';
      if (whrTarget) whrTarget.style.display='none';
      if (whrMsg)    whrMsg.textContent='';
      dialWrap.style.display='none';
      resetBtn.style.display='none';
    });
  }
})();
</script>
</body>
</html>
